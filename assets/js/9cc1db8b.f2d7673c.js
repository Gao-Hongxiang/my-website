"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6e3],{3905:(n,e,t)=>{t.d(e,{Zo:()=>l,kt:()=>m});var r=t(7294);function a(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function s(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){a(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function p(n,e){if(null==n)return{};var t,r,a=function(n,e){if(null==n)return{};var t,r,a={},o=Object.keys(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||(a[t]=n[t]);return a}(n,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(a[t]=n[t])}return a}var c=r.createContext({}),i=function(n){var e=r.useContext(c),t=e;return n&&(t="function"==typeof n?n(e):s(s({},e),n)),t},l=function(n){var e=i(n.components);return r.createElement(c.Provider,{value:e},n.children)},u={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},d=r.forwardRef((function(n,e){var t=n.components,a=n.mdxType,o=n.originalType,c=n.parentName,l=p(n,["components","mdxType","originalType","parentName"]),d=i(t),m=a,f=d["".concat(c,".").concat(m)]||d[m]||u[m]||o;return t?r.createElement(f,s(s({ref:e},l),{},{components:t})):r.createElement(f,s({ref:e},l))}));function m(n,e){var t=arguments,a=e&&e.mdxType;if("string"==typeof n||a){var o=t.length,s=new Array(o);s[0]=d;var p={};for(var c in e)hasOwnProperty.call(e,c)&&(p[c]=e[c]);p.originalType=n,p.mdxType="string"==typeof n?n:a,s[1]=p;for(var i=2;i<o;i++)s[i]=t[i];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},8498:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>p,toc:()=>i});var r=t(7462),a=(t(7294),t(3905));const o={title:"8\u3001\u7ec4\u5efa\u7684\u6e32\u67d3\u548c\u66f4\u65b0",tags:["Vue.js"]},s=void 0,p={unversionedId:"08\u7ec4\u5efa\u6e32\u67d3",id:"08\u7ec4\u5efa\u6e32\u67d3",title:"8\u3001\u7ec4\u5efa\u7684\u6e32\u67d3\u548c\u66f4\u65b0",description:"\u7ec4\u4ef6\u7684\u6302\u8f7d\u6d41\u7a0b",source:"@site/vue/08\u7ec4\u5efa\u6e32\u67d3.md",sourceDirName:".",slug:"/08\u7ec4\u5efa\u6e32\u67d3",permalink:"/website/vue/08\u7ec4\u5efa\u6e32\u67d3",draft:!1,tags:[{label:"Vue.js",permalink:"/website/vue/tags/vue-js"}],version:"current",frontMatter:{title:"8\u3001\u7ec4\u5efa\u7684\u6e32\u67d3\u548c\u66f4\u65b0",tags:["Vue.js"]},sidebar:"tutorialSidebar",previous:{title:"7\u3001Vue3\u4e2d\u7684diff\u7b97\u6cd5",permalink:"/website/vue/07Vue\u4e2d\u7684diff\u7b97\u6cd5"},next:{title:"9\u3001setup\u51fd\u6570",permalink:"/website/vue/09setup\u51fd\u6570"}},c={},i=[{value:"\u7ec4\u4ef6\u7684\u6302\u8f7d\u6d41\u7a0b",id:"\u7ec4\u4ef6\u7684\u6302\u8f7d\u6d41\u7a0b",level:2},{value:"\u6dfb\u52a0\u7ec4\u4ef6\u7c7b\u578b",id:"\u6dfb\u52a0\u7ec4\u4ef6\u7c7b\u578b",level:3},{value:"\u7ec4\u4ef6\u7684\u6e32\u67d3",id:"\u7ec4\u4ef6\u7684\u6e32\u67d3",level:3},{value:"\u7ec4\u4ef6\u5f02\u6b65\u6e32\u67d3",id:"\u7ec4\u4ef6\u5f02\u6b65\u6e32\u67d3",level:2},{value:"\u7ec4\u4ef6 Props\u3001Attrs \u5b9e\u73b0",id:"\u7ec4\u4ef6-propsattrs-\u5b9e\u73b0",level:2},{value:"initProps",id:"initprops",level:3},{value:"\u5c5e\u6027\u4ee3\u7406",id:"\u5c5e\u6027\u4ee3\u7406",level:3},{value:"\u7ec4\u4ef6\u6d41\u7a0b\u6574\u5408#",id:"\u7ec4\u4ef6\u6d41\u7a0b\u6574\u5408",level:2},{value:"1\uff09\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b#",id:"1\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b",level:3},{value:"2\uff09\u8bbe\u7f6e\u7ec4\u4ef6\u5c5e\u6027",id:"2\u8bbe\u7f6e\u7ec4\u4ef6\u5c5e\u6027",level:3},{value:"3\uff09\u6e32\u67d3 effect",id:"3\u6e32\u67d3-effect",level:3},{value:"\u5c5e\u6027\u66f4\u65b0",id:"\u5c5e\u6027\u66f4\u65b0",level:2}],l={toc:i};function u(n){let{components:e,...t}=n;return(0,a.kt)("wrapper",(0,r.Z)({},l,t,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"\u7ec4\u4ef6\u7684\u6302\u8f7d\u6d41\u7a0b"},"\u7ec4\u4ef6\u7684\u6302\u8f7d\u6d41\u7a0b"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u7ec4\u4ef6\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a render \u51fd\u6570\uff0c\u6e32\u67d3\u51fd\u6570\u9700\u8981\u8fd4\u56de\u865a\u62df DOM")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'const VueComponent = {\n  data() {\n    return { age: 13 }\n  },\n  render() {\n    return h("p", [h(Text, "I\'m Jiang sir"), h("span", this.age)])\n  },\n}\nrender(h(VueComponent), document.getElementById("app"))\n')),(0,a.kt)("h3",{id:"\u6dfb\u52a0\u7ec4\u4ef6\u7c7b\u578b"},"\u6dfb\u52a0\u7ec4\u4ef6\u7c7b\u578b"),(0,a.kt)("p",null,"h \u65b9\u6cd5\u4e2d\u4f20\u5165\u4e00\u4e2a\u5bf9\u8c61\u8bf4\u660e\u8981\u6e32\u67d3\u7684\u662f\u4e00\u4e2a\u7ec4\u4ef6\u3002\uff08\u540e\u7eed\u8fd8\u6709\u5176\u4ed6\u53ef\u80fd\uff09"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export const createVNode = (type, props, children = null) => {\n  const shapeFlag = isString(type) ? ShapeFlags.ELEMENT : isObject(type) ? ShapeFlags.STATEFUL_COMPONENT : 0\n  // ... \u7a0d\u540e\u53ef\u4ee5\u6839\u636e\u7c7b\u578b\u6765\u8fdb\u884c\u7ec4\u4ef6\u7684\u6302\u8f7d\n}\n")),(0,a.kt)("h3",{id:"\u7ec4\u4ef6\u7684\u6e32\u67d3"},"\u7ec4\u4ef6\u7684\u6e32\u67d3"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const patch = (n1, n2, container, anchor?) => {\n  // \u521d\u59cb\u5316\u548cdiff\u7b97\u6cd5\u90fd\u5728\u8fd9\u91cc\u55b2\n  if (n1 == n2) {\n    return\n  }\n  if (n1 && !isSameVNodeType(n1, n2)) {\n    // \u6709n1 \u662fn1\u548cn2\u4e0d\u662f\u540c\u4e00\u4e2a\u8282\u70b9\n    unmount(n1)\n    n1 = null\n  }\n  const { type, shapeFlag } = n2\n  switch (type) {\n    // ...\n    default:\n      if (shapeFlag & ShapeFlags.ELEMENT) {\n        processElement(n1, n2, container, anchor)\n      } else if (shapeFlag & ShapeFlags.COMPONENT) {\n        processComponent(n1, n2, container, anchor)\n      }\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const mountComponent = (n2, container, anchor) => {\n  const { render, data = () => ({}) } = n2.type\n  const state = reactive(data())\n  const instance = {\n    state, // \u7ec4\u4ef6\u7684\u72b6\u6001\n    isMounted: false, // \u7ec4\u4ef6\u662f\u5426\u6302\u8f7d\n    subTree: null, // \u5b50\u6811\n    update: null,\n    vnode: n2,\n  }\n  const componentUpdateFn = () => {\n    if (!instance.isMounted) {\n      const subTree = render.call(state, state)\n      patch(null, subTree, container, anchor)\n      instance.subTree = subTree\n      instance.isMounted = true\n    } else {\n      const subTree = render.call(state, state)\n      patch(instance.subTree, subTree, container, anchor)\n      instance.subTree = subTree\n    }\n  }\n  const effect = new ReactiveEffect(componentUpdateFn, () => update())\n  const update = (instance.update = () => effect.run())\n  update()\n}\nconst processComponent = (n1, n2, container, anchor) => {\n  if (n1 == null) {\n    mountComponent(n2, container, anchor)\n  } else {\n    // \u7ec4\u4ef6\u66f4\u65b0\u903b\u8f91\n  }\n}\n")),(0,a.kt)("h2",{id:"\u7ec4\u4ef6\u5f02\u6b65\u6e32\u67d3"},"\u7ec4\u4ef6\u5f02\u6b65\u6e32\u67d3"),(0,a.kt)("p",null,"\u4fee\u6539\u8c03\u5ea6\u65b9\u6cd5\uff0c\u5c06\u66f4\u65b0\u65b9\u6cd5\u538b\u5165\u5230\u961f\u5217\u4e2d"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const effect = new ReactiveEffect(componentUpdateFn, () => queueJob(update))\nconst update = (instance.update = () => effect.run())\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u6279\u5904\u7406\u64cd\u4f5c",(0,a.kt)("inlineCode",{parentName:"strong"},"scheduler.ts"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const queue = []\nlet isFlushing = false\nconst resolvedPromise = Promise.resolve()\nexport function queueJob(job) {\n  if (!queue.includes(job)) {\n    queue.push(job)\n  }\n  if (!isFlushing) {\n    isFlushing = true\n    resolvedPromise.then(() => {\n      isFlushing = false\n      let copy = queue.slice(0)\n      queue.length = 0 // \u8fd9\u91cc\u8981\u5148\u6e05\u7a7a\uff0c\u9632\u6b62\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5728\u52a0\u5165\u65b0\u7684job\n      for (let i = 0; i < copy.length; i++) {\n        let job = copy[i]\n        job()\n      }\n      copy.length = 0\n    })\n  }\n}\n")),(0,a.kt)("h2",{id:"\u7ec4\u4ef6-propsattrs-\u5b9e\u73b0"},"\u7ec4\u4ef6 Props\u3001Attrs \u5b9e\u73b0"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Props"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"Attrs"),"\u5173\u7cfb\u662f\uff1a\u6ca1\u6709\u5b9a\u4e49\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"component.props"),"\u4e2d\u7684\u5c5e\u6027\u5c06\u5b58\u50a8\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"attrs"),"\u5bf9\u8c61\u4e2d"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'import { render, h, Text, Fragment } from "./runtime-dom.js"\n\nconst VueComponent = {\n  data() {\n    return { name: "zs", age: 30 }\n  },\n  props: {\n    address: String,\n  },\n  render() {\n    return h("p", [\n      h(Text, `${this.name}\u4eca\u5e74${this.age}\u5c81\u4e86`),\n      h(Text, `${this.address}`),\n      h(Text, `${this.$attrs.a}\u3001${this.$attrs.b}`),\n    ])\n  },\n}\nrender(h(VueComponent, { address: "\u970d\u8425", a: 1, b: 2 }), app)\n')),(0,a.kt)("h3",{id:"initprops"},"initProps"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const mountComponent = (vnode, container, anchor) => {\n  let { data = () => ({}), render, props: propsOptions = {} } = vnode.type // \u8fd9\u4e2a\u5c31\u662f\u7528\u6237\u5199\u7684\u5185\u5bb9\n  const state = reactive(data()) // pinia \u6e90\u7801\u5c31\u662f reactive({})  \u4f5c\u4e3a\u7ec4\u4ef6\u7684\u72b6\u6001\n  const instance = {\n    // \u7ec4\u4ef6\u7684\u5b9e\u4f8b\n    state,\n    vnode, // vue2\u7684\u6e90\u7801\u4e2d\u7ec4\u4ef6\u7684\u865a\u62df\u8282\u70b9\u53eb$vnode  \u6e32\u67d3\u7684\u5185\u5bb9\u53eb_vnode\n    subTree: null, // vnode\u7ec4\u4ef6\u7684\u865a\u62df\u8282\u70b9   subTree\u6e32\u67d3\u7684\u7ec4\u4ef6\u5185\u5bb9\n    isMounted: false,\n    update: null,\n    propsOptions,\n    attrs: {},\n    props: {},\n  }\n  vnode.component = instance\n  initProps(instance, vnode.props)\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"componentProps.ts\n"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export function initProps(instance, rawProps) {\n  const props = {}\n  const attrs = {}\n  const options = instance.propsOptions || {} // \u83b7\u53d6\u7ec4\u4ef6\u7528\u6237\u7684\u914d\u7f6e\n  if (rawProps) {\n    for (let key in rawProps) {\n      const value = rawProps[key]\n      if (key in options) {\n        props[key] = value\n      } else {\n        attrs[key] = value\n      }\n    }\n  }\n  instance.props = reactive(props) // \u8fd9\u91cc\u5e94\u8be5\u7528shallowReactive\uff0c\u9075\u5faa\u5355\u5411\u6570\u636e\u6d41\u539f\u5219\n  instance.attrs = attrs\n}\n")),(0,a.kt)("h3",{id:"\u5c5e\u6027\u4ee3\u7406"},"\u5c5e\u6027\u4ee3\u7406"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"shared/index.ts")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const hasOwnProperty = Object.prototype.hasOwnProperty\nexport const hasOwn = (val, key) => hasOwnProperty.call(val, key)\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'const publicPropertiesMap = {\n  $attrs: (i) => i.attrs,\n}\n\nconst mountComponent = (vnode, container, anchor) => {\n  // ...\n  const instance = {\n    // \u7ec4\u4ef6\u7684\u5b9e\u4f8b\n    // ...\n    proxy: null,\n  }\n  vnode.component = instance\n  initProps(instance, vnode.props)\n  instance.proxy = new Proxy(instance, {\n    get(target, key) {\n      const { data, props } = target\n      if (data && hasOwn(data, key)) {\n        return data[key]\n      } else if (hasOwn(props, key)) {\n        return props[key]\n      }\n      const publicGetter = publicPropertiesMap[key]\n      if (publicGetter) {\n        return publicGetter(target)\n      }\n    },\n    set(target, key, value) {\n      const { data, props } = target\n      if (data && hasOwn(data, key)) {\n        data[key] = value\n        return true\n      } else if (hasOwn(props, key)) {\n        console.warn(`Attempting to mutate prop "${key}". Props are readonly.`)\n        return false\n      }\n      return true\n    },\n  })\n}\n')),(0,a.kt)("h2",{id:"\u7ec4\u4ef6\u6d41\u7a0b\u6574\u5408"},"\u7ec4\u4ef6\u6d41\u7a0b\u6574\u5408",(0,a.kt)("a",{parentName:"h2",href:"http://zhufengpeixun.com/vue-lesson/vue3/12.component.html#%E7%BB%84%E4%BB%B6%E6%B5%81%E7%A8%8B%E6%95%B4%E5%90%88"},"#")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const mountComponent = (vnode, container, anchor) => {\n  // 1) \u521b\u5efa\u5b9e\u4f8b\n  const instance = (vnode.component = createComponentInstance(vnode))\n  // 2) \u7ed9\u5b9e\u4f8b\u8d4b\u503c\n  setupComponent(instance)\n  // 3) \u521b\u5efa\u6e32\u67d3effect\u53ca\u66f4\u65b0\n  setupRenderEffect(instance, container, anchor)\n}\n")),(0,a.kt)("h3",{id:"1\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b"},"1\uff09\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b",(0,a.kt)("a",{parentName:"h3",href:"http://zhufengpeixun.com/vue-lesson/vue3/12.component.html#_1%EF%BC%89%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B"},"#")),(0,a.kt)("blockquote",null,(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"component.ts\n"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export function createComponentInstance(vnode) {\n  const instance = {\n    // \u7ec4\u4ef6\u7684\u5b9e\u4f8b\n    data: null,\n    vnode, // vue2\u7684\u6e90\u7801\u4e2d\u7ec4\u4ef6\u7684\u865a\u62df\u8282\u70b9\u53eb$vnode  \u6e32\u67d3\u7684\u5185\u5bb9\u53eb_vnode\n    subTree: null, // vnode\u7ec4\u4ef6\u7684\u865a\u62df\u8282\u70b9   subTree\u6e32\u67d3\u7684\u7ec4\u4ef6\u5185\u5bb9\n    isMounted: false,\n    update: null,\n    attrs: {},\n    props: {},\n    proxy: null,\n    propsOptions: vnode.type.props,\n  }\n  return instance\n}\n")),(0,a.kt)("h3",{id:"2\u8bbe\u7f6e\u7ec4\u4ef6\u5c5e\u6027"},"2\uff09\u8bbe\u7f6e\u7ec4\u4ef6\u5c5e\u6027"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'const publicPropertiesMap = {\n  $attrs: (i) => i.attrs,\n}\nconst PublicInstanceProxyHandlers = {\n  get(target, key) {\n    const { data, props } = target\n    if (data && hasOwn(data, key)) {\n      return data[key]\n    } else if (hasOwn(props, key)) {\n      return props[key]\n    }\n    const publicGetter = publicPropertiesMap[key]\n    if (publicGetter) {\n      return publicGetter(target)\n    }\n  },\n  set(target, key, value) {\n    const { data, props } = target\n    if (data && hasOwn(data, key)) {\n      data[key] = value\n      return true\n    } else if (hasOwn(props, key)) {\n      console.warn(`Attempting to mutate prop "${key}". Props are readonly.`)\n      return false\n    }\n    return true\n  },\n}\nexport function setupComponent(instance) {\n  const { props, type } = instance.vnode\n  initProps(instance, props)\n  instance.proxy = new Proxy(instance, PublicInstanceProxyHandlers)\n  const data = type.data\n  if (data) {\n    if (!isFunction(data)) return console.warn("The data option must be a function.")\n    instance.data = reactive(data.call(instance.proxy))\n  }\n  instance.render = type.render\n}\n')),(0,a.kt)("h3",{id:"3\u6e32\u67d3-effect"},"3\uff09\u6e32\u67d3 effect"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const setupRenderEffect = (instance, container, anchor) => {\n  const { render } = instance\n  const componentUpdateFn = () => {\n    // \u533a\u5206\u662f\u521d\u59cb\u5316 \u8fd8\u662f\u8981\u66f4\u65b0\n    if (!instance.isMounted) {\n      // \u521d\u59cb\u5316\n      const subTree = render.call(instance.proxy, instance.proxy) // \u4f5c\u4e3athis\uff0c\u540e\u7eedthis\u4f1a\u6539\n      patch(null, subTree, container, anchor) // \u521b\u9020\u4e86subTree\u7684\u771f\u5b9e\u8282\u70b9\u5e76\u4e14\u63d2\u5165\u4e86\n      instance.subTree = subTree\n      instance.isMounted = true\n    } else {\n      // \u7ec4\u4ef6\u5185\u90e8\u66f4\u65b0\n      const subTree = render.call(instance.proxy, instance.proxy)\n      patch(instance.subTree, subTree, container, anchor)\n      instance.subTree = subTree\n    }\n  }\n  // \u7ec4\u4ef6\u7684\u5f02\u6b65\u66f4\u65b0\n  const effect = new ReactiveEffect(componentUpdateFn, () => queueJob(update))\n  // \u6211\u4eec\u5c06\u7ec4\u4ef6\u5f3a\u5236\u66f4\u65b0\u7684\u903b\u8f91\u4fdd\u5b58\u5230\u4e86\u7ec4\u4ef6\u7684\u5b9e\u4f8b\u4e0a\uff0c\u540e\u7eed\u53ef\u4ee5\u4f7f\u7528\n  const update = (instance.update = () => effect.run())\n  update()\n}\n")),(0,a.kt)("h2",{id:"\u5c5e\u6027\u66f4\u65b0"},"\u5c5e\u6027\u66f4\u65b0"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'const My = {\n  props: { address: String },\n  render() {\n    return h("div", this.address)\n  },\n}\nconst VueComponent = {\n  data() {\n    return { name: "zs", age: 30, flag: false }\n  },\n  render() {\n    return h(Fragment, [\n      h("button", { onClick: () => (this.flag = !this.flag) }, "\u5207\u6362\u6e32\u67d3"),\n      h(My, { address: this.flag ? "\u970d\u8425" : "\u56de\u9f99\u89c2" }),\n    ])\n  },\n}\nrender(h(VueComponent), app)\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const updateComponent = (n1, n2) => {\n  const instance = (n2.component = n1.component)\n  const { props: prevProps } = n1\n  const { props: nextProps } = n2\n  updateProps(instance, prevProps, nextProps)\n}\nconst processComponent = (n1, n2, container, anchor) => {\n  if (n1 == null) {\n    mountComponent(n2, container, anchor)\n  } else {\n    // \u7ec4\u4ef6\u66f4\u65b0\u903b\u8f91\n    updateComponent(n1, n2)\n  }\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"props.ts\n"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export const hasPropsChanged = (prevProps = {}, nextProps = {}) => {\n  const nextKeys = Object.keys(nextProps)\n  if (nextKeys.length !== Object.keys(prevProps).length) {\n    return true\n  }\n  for (let i = 0; i < nextKeys.length; i++) {\n    const key = nextKeys[i]\n    if (nextProps[key] !== prevProps[key]) {\n      return true\n    }\n  }\n  return false\n}\nexport function updateProps(instance, prevProps, nextProps) {\n  if (hasPropsChanged(prevProps, nextProps)) {\n    // \u6bd4\u8f83\u524d\u540e\u5c5e\u6027\u662f\u5426\u4e00\u81f4\n    for (const key in nextProps) {\n      // \u5faa\u73afprops\n      instance.props[key] = nextProps[key] // \u54cd\u5e94\u5f0f\u5c5e\u6027\u66f4\u65b0\u540e\u4f1a\u91cd\u65b0\u6e32\u67d3\n    }\n    for (const key in instance.props) {\n      // \u5faa\u73afprops\n      if (!(key in nextProps)) {\n        delete instance.props[key]\n      }\n    }\n  }\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u6211\u4eec\u5c06\u66f4\u65b0\u903b\u8f91\u653e\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"componentFn"),"\u4e2d\uff0c\u56e0\u4e3a\u9664\u4e86\u5c5e\u6027\u66f4\u65b0\u4e4b\u5916\uff0c\u63d2\u69fd\u4e5f\u4f1a\u5bfc\u81f4\u9875\u9762\u66f4\u65b0")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const shouldUpdateComponent = (n1, n2) => {\n  const { props: prevProps, children: prevChildren } = n1\n  const { props: nextProps, children: nextChildren } = n2\n\n  if (prevChildren || nextChildren) return true\n\n  if (prevProps === nextProps) return false\n  return hasPropsChanged(prevProps, nextProps)\n}\nconst updateComponent = (n1, n2) => {\n  const instance = (n2.component = n1.component)\n  if (shouldUpdateComponent(n1, n2)) {\n    instance.next = n2 // \u5c06\u65b0\u7684\u865a\u62df\u8282\u70b9\u653e\u5230next\u5c5e\u6027\u4e0a\n    instance.update() // \u5c5e\u6027\u53d8\u5316\u624b\u52a8\u8c03\u7528\u66f4\u65b0\u65b9\u6cd5\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export function updateProps(prevProps, nextProps) {\n  for (const key in nextProps) {\n    // \u5faa\u73afprops\n    prevProps[key] = nextProps[key] // \u54cd\u5e94\u5f0f\u5c5e\u6027\u66f4\u65b0\u540e\u4f1a\u91cd\u65b0\u6e32\u67d3\n  }\n  for (const key in prevProps) {\n    // \u5faa\u73afprops\n    if (!(key in nextProps)) {\n      delete prevProps[key]\n    }\n  }\n}\nfunction updateComponentPreRender(instance, next) {\n  instance.next = null\n  instance.vnode = next\n  updateProps(instance, instance.props, next.props)\n}\nconst componentUpdateFn = () => {\n  if (!instance.isMounted) {\n    // ...\n  } else {\n    let { next } = instance\n    if (next) {\n      updateComponentPreRender(instance, next)\n    }\n    const subTree = render.call(instance.proxy, instance.proxy)\n    patch(instance.subTree, subTree, container, anchor)\n    instance.subTree = subTree\n  }\n}\n")))}u.isMDXComponent=!0}}]);