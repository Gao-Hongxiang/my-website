"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5674],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>b});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=p(n),b=r,d=m["".concat(s,".").concat(b)]||m[b]||c[b]||l;return n?a.createElement(d,i(i({ref:t},u),{},{components:n})):a.createElement(d,i({ref:t},u))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5607:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const l={title:"5. AST\u8bed\u6cd5\u6811",sidebar_position:5},i=void 0,o={unversionedId:"ast",id:"ast",title:"5. AST\u8bed\u6cd5\u6811",description:"1.\u62bd\u8c61\u8bed\u6cd5\u6811(Abstract Syntax Tree)",source:"@site/engineering/05-ast.md",sourceDirName:".",slug:"/ast",permalink:"/website/engineering/ast",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"5. AST\u8bed\u6cd5\u6811",sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"4. webpack \u6253\u5305\u540e\u6a21\u5757\u5206\u6790",permalink:"/website/engineering/bundle"},next:{title:"5. webpack \u7f16\u8bd1\u6d41\u7a0b",permalink:"/website/engineering/webpackFlow"}},s={},p=[{value:"1.\u62bd\u8c61\u8bed\u6cd5\u6811(Abstract Syntax Tree)",id:"1\u62bd\u8c61\u8bed\u6cd5\u6811abstract-syntax-tree",level:2},{value:"2.\u62bd\u8c61\u8bed\u6cd5\u6811\u7528\u9014",id:"2\u62bd\u8c61\u8bed\u6cd5\u6811\u7528\u9014",level:2},{value:"3.\u62bd\u8c61\u8bed\u6cd5\u6811\u5b9a\u4e49",id:"3\u62bd\u8c61\u8bed\u6cd5\u6811\u5b9a\u4e49",level:2},{value:"4.AST \u904d\u5386",id:"4ast-\u904d\u5386",level:2},{value:"5.babel",id:"5babel",level:2},{value:"5.3 Visitor",id:"53-visitor",level:3},{value:"5.3.1 path",id:"531-path",level:4},{value:"5.3.2 scope",id:"532-scope",level:4},{value:"5.1 \u5b9e\u73b0\u65e5\u5fd7\u63d2\u4ef6",id:"51-\u5b9e\u73b0\u65e5\u5fd7\u63d2\u4ef6",level:3},{value:"5.1.1 logger.js",id:"511-loggerjs",level:4},{value:"5.7 \u81ea\u52a8\u65e5\u5fd7\u63d2\u4ef6",id:"57-\u81ea\u52a8\u65e5\u5fd7\u63d2\u4ef6",level:3},{value:"5.2.1 use.js",id:"521-usejs",level:4},{value:"5.2.2 autoLoggerPlugin.js",id:"522-autologgerpluginjs",level:4},{value:"5.3 eslint",id:"53-eslint",level:3},{value:"5.3.1 use.js",id:"531-usejs",level:4},{value:"5.3.2 eslintPlugin.js",id:"532-eslintpluginjs",level:4},{value:"6. webpack \u4e2d\u4f7f\u7528 babel \u63d2\u4ef6",id:"6-webpack-\u4e2d\u4f7f\u7528-babel-\u63d2\u4ef6",level:2},{value:"6.1.1 webpack \u914d\u7f6e",id:"611-webpack-\u914d\u7f6e",level:4},{value:"6.1.2 babel \u63d2\u4ef6",id:"612-babel-\u63d2\u4ef6",level:4},{value:"7. \u53c2\u8003",id:"7-\u53c2\u8003",level:2}],u={toc:p};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"1\u62bd\u8c61\u8bed\u6cd5\u6811abstract-syntax-tree"},"1.\u62bd\u8c61\u8bed\u6cd5\u6811(Abstract Syntax Tree)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u62bd\u8c61\u8bed\u6cd5\u6811\uff08Abstract Syntax Tree\uff0cAST\uff09\u662f\u6e90\u4ee3\u7801\u8bed\u6cd5\u7ed3\u6784\u7684\u4e00\u79cd\u62bd\u8c61\u8868\u793a"),(0,r.kt)("li",{parentName:"ul"},"\u5b83\u4ee5\u6811\u72b6\u7684\u5f62\u5f0f\u8868\u73b0\u7f16\u7a0b\u8bed\u8a00\u7684\u8bed\u6cd5\u7ed3\u6784\uff0c\u6811\u4e0a\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u8868\u793a\u6e90\u4ee3\u7801\u4e2d\u7684\u4e00\u79cd\u7ed3\u6784")),(0,r.kt)("h2",{id:"2\u62bd\u8c61\u8bed\u6cd5\u6811\u7528\u9014"},"2.\u62bd\u8c61\u8bed\u6cd5\u6811\u7528\u9014"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4ee3\u7801\u8bed\u6cd5\u7684\u68c0\u67e5\u3001\u4ee3\u7801\u98ce\u683c\u7684\u68c0\u67e5\u3001\u4ee3\u7801\u7684\u683c\u5f0f\u5316\u3001\u4ee3\u7801\u7684\u9ad8\u4eae\u3001\u4ee3\u7801\u9519\u8bef\u63d0\u793a\u3001\u4ee3\u7801\u81ea\u52a8\u8865\u5168\u7b49\u7b49"),(0,r.kt)("li",{parentName:"ul"},"\u4f18\u5316\u53d8\u66f4\u4ee3\u7801\uff0c\u6539\u53d8\u4ee3\u7801\u7ed3\u6784\u4f7f\u8fbe\u5230\u60f3\u8981\u7684\u7ed3\u6784")),(0,r.kt)("h2",{id:"3\u62bd\u8c61\u8bed\u6cd5\u6811\u5b9a\u4e49"},"3.\u62bd\u8c61\u8bed\u6cd5\u6811\u5b9a\u4e49"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8fd9\u4e9b\u5de5\u5177\u7684\u539f\u7406\u90fd\u662f\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"li"},"JavaScript Parser"),"\u628a\u4ee3\u7801\u8f6c\u5316\u4e3a\u4e00\u9897\u62bd\u8c61\u8bed\u6cd5\u6811\uff08AST\uff09\uff0c\u8fd9\u9897\u6811\u5b9a\u4e49\u4e86\u4ee3\u7801\u7684\u7ed3\u6784\uff0c\u901a\u8fc7\u64cd\u7eb5\u8fd9\u9897\u6811\uff0c\u6211\u4eec\u53ef\u4ee5\u7cbe\u51c6\u7684\u5b9a\u4f4d\u5230\u58f0\u660e\u8bed\u53e5\u3001\u8d4b\u503c\u8bed\u53e5\u3001\u8fd0\u7b97\u8bed\u53e5\u7b49\u7b49\uff0c\u5b9e\u73b0\u5bf9\u4ee3\u7801\u7684\u5206\u6790\u3001\u4f18\u5316\u3001\u53d8\u66f4\u7b49\u64cd\u4f5c")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img/20230301103909.png",alt:null})),(0,r.kt)("h2",{id:"4ast-\u904d\u5386"},"4.AST \u904d\u5386"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://astexplorer.net/"},"astexplorer")),(0,r.kt)("li",{parentName:"ul"},"AST \u662f\u6df1\u5ea6\u4f18\u5148\u904d\u5386")),(0,r.kt)("h2",{id:"5babel"},"5.babel"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Babel \u80fd\u591f\u8f6c\u8bd1 ",(0,r.kt)("inlineCode",{parentName:"li"},"ECMAScript 2015+")," \u7684\u4ee3\u7801\uff0c\u4f7f\u5b83\u5728\u65e7\u7684\u6d4f\u89c8\u5668\u6216\u8005\u73af\u5883\u4e2d\u4e5f\u80fd\u591f\u8fd0\u884c"),(0,r.kt)("li",{parentName:"ul"},"\u5de5\u4f5c\u8fc7\u7a0b\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Parse(\u89e3\u6790) \u5c06\u6e90\u4ee3\u7801\u8f6c\u6362\u6210\u62bd\u8c61\u8bed\u6cd5\u6811\uff0c\u6811\u4e0a\u6709\u5f88\u591a\u7684",(0,r.kt)("a",{parentName:"li",href:"https://github.com/estree/estree"},"estree \u8282\u70b9")),(0,r.kt)("li",{parentName:"ul"},"Transform(\u8f6c\u6362) \u5bf9\u62bd\u8c61\u8bed\u6cd5\u6811\u8fdb\u884c\u8f6c\u6362"),(0,r.kt)("li",{parentName:"ul"},"Generate(\u4ee3\u7801\u751f\u6210) \u5c06\u4e0a\u4e00\u6b65\u7ecf\u8fc7\u8f6c\u6362\u8fc7\u7684\u62bd\u8c61\u8bed\u6cd5\u6811\u751f\u6210\u65b0\u7684\u4ee3\u7801")))),(0,r.kt)("h3",{id:"53-visitor"},"5.3 Visitor"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8bbf\u95ee\u8005\u6a21\u5f0f Visitor \u5bf9\u4e8e\u67d0\u4e2a\u5bf9\u8c61\u6216\u8005\u4e00\u7ec4\u5bf9\u8c61\uff0c\u4e0d\u540c\u7684\u8bbf\u95ee\u8005\uff0c\u4ea7\u751f\u7684\u7ed3\u679c\u4e0d\u540c\uff0c\u6267\u884c\u64cd\u4f5c\u4e5f\u4e0d\u540c"),(0,r.kt)("li",{parentName:"ul"},"Visitor \u7684\u5bf9\u8c61\u5b9a\u4e49\u4e86\u7528\u4e8e AST \u4e2d\u83b7\u53d6\u5177\u4f53\u8282\u70b9\u7684\u65b9\u6cd5"),(0,r.kt)("li",{parentName:"ul"},"Visitor \u4e0a\u6302\u8f7d\u4ee5\u8282\u70b9 ",(0,r.kt)("inlineCode",{parentName:"li"},"type")," \u547d\u540d\u7684\u65b9\u6cd5\uff0c\u5f53\u904d\u5386 AST \u7684\u65f6\u5019\uff0c\u5982\u679c\u5339\u914d\u4e0a type\uff0c\u5c31\u4f1a\u6267\u884c\u5bf9\u5e94\u7684\u65b9\u6cd5")),(0,r.kt)("h4",{id:"531-path"},"5.3.1 path"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/babel/babel/blob/main/packages/babel-traverse/src/path/index.ts"},"path")),(0,r.kt)("li",{parentName:"ul"},"node \u5f53\u524d AST \u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"parent \u7236 AST \u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"parentPath \u7236 AST \u8282\u70b9\u7684\u8def\u5f84"),(0,r.kt)("li",{parentName:"ul"},"scope \u4f5c\u7528\u57df"),(0,r.kt)("li",{parentName:"ul"},"get(key) \u83b7\u53d6\u67d0\u4e2a\u5c5e\u6027\u7684 path"),(0,r.kt)("li",{parentName:"ul"},"set(key, node) \u8bbe\u7f6e\u67d0\u4e2a\u5c5e\u6027"),(0,r.kt)("li",{parentName:"ul"},"is \u7c7b\u578b(opts) \u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u662f\u67d0\u4e2a\u7c7b\u578b"),(0,r.kt)("li",{parentName:"ul"},"find(callback) \u4ece\u5f53\u524d\u8282\u70b9\u4e00\u76f4\u5411\u4e0a\u627e\u5230\u6839\u8282\u70b9(\u5305\u62ec\u81ea\u5df1)"),(0,r.kt)("li",{parentName:"ul"},"findParent(callback)\u4ece\u5f53\u524d\u8282\u70b9\u4e00\u76f4\u5411\u4e0a\u627e\u5230\u6839\u8282\u70b9(\u4e0d\u5305\u62ec\u81ea\u5df1)"),(0,r.kt)("li",{parentName:"ul"},"insertBefore(nodes) \u5728\u4e4b\u524d\u63d2\u5165\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"insertAfter(nodes) \u5728\u4e4b\u540e\u63d2\u5165\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"replaceWith(replacement) \u7528\u67d0\u4e2a\u8282\u70b9\u66ff\u6362\u5f53\u524d\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"replaceWithMultiple(nodes) \u7528\u591a\u4e2a\u8282\u70b9\u66ff\u6362\u5f53\u524d\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"replaceWithSourceString(replacement) \u628a\u6e90\u4ee3\u7801\u8f6c\u6210 AST \u8282\u70b9\u518d\u66ff\u6362\u5f53\u524d\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"remove() \u5220\u9664\u5f53\u524d\u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},"traverse(visitor, state) \u904d\u5386\u5f53\u524d\u8282\u70b9\u7684\u5b50\u8282\u70b9,\u7b2c 1 \u4e2a\u53c2\u6570\u662f\u8282\u70b9\uff0c\u7b2c 2 \u4e2a\u53c2\u6570\u662f\u7528\u6765\u4f20\u9012\u6570\u636e\u7684\u72b6\u6001"),(0,r.kt)("li",{parentName:"ul"},"skip() \u8df3\u8fc7\u5f53\u524d\u8282\u70b9\u5b50\u8282\u70b9\u7684\u904d\u5386"),(0,r.kt)("li",{parentName:"ul"},"stop() \u7ed3\u675f\u6240\u6709\u7684\u904d\u5386")),(0,r.kt)("h4",{id:"532-scope"},"5.3.2 scope"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/babel/babel/blob/main/packages/babel-traverse/src/scope/index.ts"},"scope")),(0,r.kt)("li",{parentName:"ul"},"scope.bindings \u5f53\u524d\u4f5c\u7528\u57df\u5185\u58f0\u660e\u6240\u6709\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"scope.path \u751f\u6210\u4f5c\u7528\u57df\u7684\u8282\u70b9\u5bf9\u5e94\u7684\u8def\u5f84"),(0,r.kt)("li",{parentName:"ul"},"scope.references \u6240\u6709\u7684\u53d8\u91cf\u5f15\u7528\u7684\u8def\u5f84"),(0,r.kt)("li",{parentName:"ul"},"getAllBindings() \u83b7\u53d6\u4ece\u5f53\u524d\u4f5c\u7528\u57df\u4e00\u76f4\u5230\u6839\u4f5c\u7528\u57df\u7684\u96c6\u5408"),(0,r.kt)("li",{parentName:"ul"},"getBinding(name) \u4ece\u5f53\u524d\u4f5c\u7528\u57df\u5230\u6839\u4f7f\u7528\u57df\u67e5\u627e\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"getOwnBinding(name) \u5728\u5f53\u524d\u4f5c\u7528\u57df\u67e5\u627e\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"parentHasBinding(name, noGlobals) \u4ece\u5f53\u524d\u7236\u4f5c\u7528\u57df\u5230\u6839\u4f7f\u7528\u57df\u67e5\u627e\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"removeBinding(name) \u5220\u9664\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"hasBinding(name, noGlobals) \u5224\u65ad\u662f\u5426\u5305\u542b\u53d8\u91cf"),(0,r.kt)("li",{parentName:"ul"},"moveBindingTo(name, scope) \u628a\u5f53\u524d\u4f5c\u7528\u57df\u7684\u53d8\u91cf\u79fb\u52a8\u5230\u5176\u5b83\u4f5c\u7528\u57df\u4e2d"),(0,r.kt)("li",{parentName:"ul"},"generateUid(name) \u751f\u6210\u4f5c\u7528\u57df\u4e2d\u7684\u552f\u4e00\u53d8\u91cf\u540d,\u5982\u679c\u53d8\u91cf\u540d\u88ab\u5360\u7528\u5c31\u5728\u524d\u9762\u52a0\u4e0b\u5212\u7ebf")),(0,r.kt)("h3",{id:"51-\u5b9e\u73b0\u65e5\u5fd7\u63d2\u4ef6"},"5.1 \u5b9e\u73b0\u65e5\u5fd7\u63d2\u4ef6"),(0,r.kt)("h4",{id:"511-loggerjs"},"5.1.1 logger.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const { transformSync } = require("@babel/core")\nconst types = require("@babel/types")\nconst path = require("path")\nconst sourceCode = `\nconsole.log("hello");\n`\nconst visitor = {\n  CallExpression(nodePath, state) {\n    const { node } = nodePath\n    if (types.isMemberExpression(node.callee)) {\n      if (node.callee.object.name === "console") {\n        if (["log", "warn", "info", "error", "debug"].includes(node.callee.property.name)) {\n          const { line, column } = node.loc.start\n          // \u83b7\u53d6\u76f8\u5bf9\u4e8e\u5f53\u524d\u6587\u4ef6\u7684\u6587\u4ef6\u540d\u5e76\u5c06\u53cd\u659c\u6760\u66ff\u6362\u4e3a\u6b63\u659c\u6760\n          const relativeFileName = path.relative(__dirname, state.file.opts.filename).replace(/\\\\/g, "/")\n          // \u5c06\u6587\u4ef6\u540d\u548c\u4f4d\u7f6e\u4fe1\u606f\u63d2\u5165\u5230\u53c2\u6570\u5217\u8868\u7684\u5f00\u5934\n          node.arguments.unshift(types.stringLiteral(`${relativeFileName} ${line}:${column}`))\n        }\n      }\n    }\n  },\n}\n\nfunction logParamPlugin() {\n  return {\n    visitor,\n  }\n}\nconst { code } = transformSync(sourceCode, {\n  filename: "any.js",\n  plugins: [logParamPlugin()],\n})\nconsole.log(code)\n')),(0,r.kt)("h3",{id:"57-\u81ea\u52a8\u65e5\u5fd7\u63d2\u4ef6"},"5.7 \u81ea\u52a8\u65e5\u5fd7\u63d2\u4ef6"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://babeljs.io/docs/en/babel-helper-plugin-utils"},"babel-helper-plugin-utils")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://babeljs.io/docs/en/babel-types.html#api"},"babel-types"),"\u7528\u6765\u751f\u6210\u8282\u70b9\u548c\u5224\u65ad\u8282\u70b9\u7c7b\u578b"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://babeljs.io/docs/en/babel-helper-module-imports"},"babel-helper-module-imports"),"\u5e2e\u52a9\u63d2\u5165\u6a21\u5757"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@babel/template"},"@babel/template"),"\u6839\u636e\u5b57\u7b26\u4e32\u6a21\u677f\u751f\u6210 AST \u8282\u70b9"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"state")," \u7528\u4e8e\u5728\u904d\u5386\u8fc7\u7a0b\u4e2d\u5728 AST \u8282\u70b9\u4e4b\u95f4\u4f20\u9012\u6570\u636e\u7684\u65b9\u5f0f")),(0,r.kt)("h4",{id:"521-usejs"},"5.2.1 use.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const { transformSync } = require("@babel/core")\nconst types = require("@babel/types")\nconst path = require("path")\nconst autoLoggerPlugin = require("./autoLoggerPlugin")\nconst sourceCode = `\nlet _logger2 = \'xxx\';\nfunction sum(a,b){\n    return a+b;\n}\nconst multiply = function(a,b){\n    return a*b;\n}\nconst minis = (a,b)=>a-b;\nclass Math{\n    divide(a,b){\n        return a/b;\n    }\n}\n`\nconst { code } = transformSync(sourceCode, {\n  filename: "some.js",\n  plugins: [\n    autoLoggerPlugin({\n      fnNames: ["sum"],\n      libName: "logger", //\u628a\u83b7\u53d6\u4e1a\u52a1\u6570\u636e\u7684\u903b\u8f91\u5199\u5728logger\u91cc\n      params: ["a", "b", "c"],\n    }),\n  ],\n})\nconsole.log(code)\n')),(0,r.kt)("h4",{id:"522-autologgerpluginjs"},"5.2.2 autoLoggerPlugin.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const types = require("@babel/types")\nconst pathLib = require("path")\nconst importModuleHelper = require("@babel/helper-module-imports")\nconst template = require("@babel/template")\n\nfunction autoLoggerPlugin(options) {\n  return {\n    visitor: {\n      Program: {\n        //state \u53ef\u4ee5\u5728\u904d\u5386\u8fc7\u7a0b\u4fdd\u5b58\u548c\u4f20\u9012\u72b6\u6001\n        enter(path, state) {\n          let loggerId\n          path.traverse({\n            ImportDeclaration(path) {\n              debugger\n              //\u83b7\u53d6\u5bfc\u5165\u5e93\u7684\u540d\u79f0\n              //const libName = path.node.source.value;\n              //jquery.find \u5728path\u7684\u4e0b\u5c42\u5c5e\u6027\u4e2d\u5bfb\u627e\u5c5e\u6027\u540d\u4e3asource\u7684\u8def\u5f84path,\n              const libName = path.get("source").node.value\n              //\u5982\u679c\u6b64\u5bfc\u5165\u8bed\u53e5\u5bfc\u5165\u7684\u7b2c\u4e09\u65b9\u6a21\u5757\u548c\u914d\u7f6e\u7684\u65e5\u5fd7\u7b2c\u4e09\u65b9\u5e93\u540d\u79f0\u4e00\u6837\n              if (options.libName === libName) {\n                const specifierPath = path.get("specifiers.0")\n                if (\n                  specifierPath.isImportDefaultSpecifier() ||\n                  specifierPath.isImportSpecifier() ||\n                  specifierPath.isImportNamespaceSpecifier()\n                ) {\n                  loggerId = specifierPath.node.local\n                }\n                path.stop() //\u505c\u6b62\u904d\u5386\u67e5\u627e\n              }\n            },\n          })\n          //\u5982\u679c\u904d\u5386\u5b8cProgram\uff0cloggerId\u8fd8\u662f\u7a7a\u7684\uff0c\u90a3\u8bf4\u660e\u5728\u6e90\u7801\u4e2d\u5c1a\u672a\u5bfc\u5165logger\u6a21\u5757\n          if (!loggerId) {\n            loggerId = importModuleHelper.addDefault(path, options.libName, {\n              //\u5728Program\u4f5c\u7528\u57df\u5185\u751f\u6210\u4e00\u4e2a\u4e0d\u4f1a\u4e0e\u5f53\u524d\u4f5c\u7528\u57df\u5185\u53d8\u91cf\u91cd\u590d\u7684\u53d8\u91cf\u540d\n              nameHint: path.scope.generateUid(options.libName),\n            })\n          }\n          //\u4f7f\u7528template\u6a21\u5757\u751f\u6210\u4e00\u4e2aast\u8bed\u6cd5\u6811\u8282\u70b9,\u628a\u4e00\u4e2a\u5b57\u7b26\u4e32\u53d8\u6210\u8282\u70b9\n          state.loggerNode = template.statement(`LOGGER_PLACE();`)({\n            LOGGER_PLACE: loggerId.name,\n          })\n          //state.loggerNode = types.expressionStatement(types.callExpression(loggerId,[]));\n        },\n      },\n      "FunctionDeclaration|FunctionExpression|ArrowFunctionExpression|ClassMethod"(path, state) {\n        const { node } = path\n        let fnName\n        if (node.type === "FunctionDeclaration") {\n          fnName = node.id.name\n        }\n        if (options.fnNames.includes(fnName)) {\n          if (types.isBlockStatement(node.body)) {\n            node.body.body.unshift(state.loggerNode)\n          } else {\n            const newNode = types.blockStatement([state.loggerNode, types.returnStatement(node.body)])\n            path.get("body").replaceWith(newNode)\n          }\n        }\n      },\n    },\n  }\n}\nmodule.exports = autoLoggerPlugin\n')),(0,r.kt)("h3",{id:"53-eslint"},"5.3 eslint"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://https//eslint.bootcss.com/docs/rules/"},"rules"))),(0,r.kt)("h4",{id:"531-usejs"},"5.3.1 use.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const { transformSync } = require("@babel/core")\nconst types = require("@babel/types")\nconst path = require("path")\nconst noConsolePlugin = require("./noConsolePlugin")\nconst sourceCode = `\nvar a = 1;\nconsole.log(a);\nvar b = 2;\n`\nconst { code } = transformSync(sourceCode, {\n  filename: "./some.js",\n  plugins: [\n    noConsolePlugin({\n      fix: true,\n    }),\n  ],\n})\nconsole.log(code)\n')),(0,r.kt)("h4",{id:"532-eslintpluginjs"},"5.3.2 eslintPlugin.js"),(0,r.kt)("p",null,"eslintPlugin.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function noConsolePlugin(options) {\n  return {\n    pre(file) {\n      file.set("errors", [])\n    },\n    visitor: {\n      CallExpression(path, state) {\n        const { node } = path\n        const errors = state.file.get("errors")\n        if (node.callee.object && node.callee.object.name === "console") {\n          const stackTraceLimit = Error.stackTraceLimit\n          Error.stackTraceLimit = 0\n          errors.push(path.buildCodeFrameError(`\u4ee3\u7801\u4e2d\u4e0d\u80fd\u51fa\u73b0console\u8bed\u53e5`, Error))\n          Error.stackTraceLimit = stackTraceLimit\n          if (options.fix) {\n            //\u5982\u679c\u9700\u8981\u81ea\u52a8\u4fee\u590d\uff0c\u5c31\u5220\u9664\u6b64\u8bed\u53e5\n            path.parentPath.remove()\n          }\n        }\n      },\n    },\n    post(file) {\n      console.log(...file.get("errors"))\n    },\n  }\n}\nmodule.exports = noConsolePlugin\n')),(0,r.kt)("h2",{id:"6-webpack-\u4e2d\u4f7f\u7528-babel-\u63d2\u4ef6"},"6. webpack \u4e2d\u4f7f\u7528 babel \u63d2\u4ef6"),(0,r.kt)("h4",{id:"611-webpack-\u914d\u7f6e"},"6.1.1 webpack \u914d\u7f6e"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'npm i webpack webpack-cli babel-plugin-import -D\nconst path = require("path");\nmodule.exports = {\n  mode: "development",\n  entry: "./src/index.js",\n  output: {\n    path: path.resolve("dist"),\n    filename: "bundle.js",\n  },\n  module: {\n    rules: [\n      {\n        test: /\\.js$/,\n        {\n            loader:\'babel-loader\',\n            options:{\n                "plugins": [[\n                    path.resolve(\'./plugins/babel-plugin-import.js\')\n                    , {\n                    "libraryDirectory": "",\n                    "libraryName": "lodash"\n                  }]]\n            }\n        },\n      },\n    ],\n  },\n};\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u7f16\u8bd1\u987a\u5e8f\u4e3a\u9996\u5148",(0,r.kt)("inlineCode",{parentName:"p"},"plugins"),"\u4ece\u5de6\u5f80\u53f3,\u7136\u540e",(0,r.kt)("inlineCode",{parentName:"p"},"presets"),"\u4ece\u53f3\u5f80\u5de6")),(0,r.kt)("h4",{id:"612-babel-\u63d2\u4ef6"},"6.1.2 babel \u63d2\u4ef6"),(0,r.kt)("p",null,"plugins\\babel-plugin-import.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const types = require("@babel/types")\nconst template = require("@babel/template")\nfunction babelPluginImport() {\n  return {\n    visitor: {\n      ImportDeclaration(path, state) {\n        const { node } = path\n        const { specifiers } = node\n        const { libraryName, libraryDirectory = "lib" } = state.opts\n        if (node.source.value === libraryName && !types.isImportDefaultSpecifier(specifiers[0])) {\n          const newImportDeclarations = specifiers.map((specifier) => {\n            return template.statement(\n              `import ${specifier.local.name} from \'${libraryName}/${specifier.imported.name}\';`\n            )()\n            /* return types.importDeclaration(\n                        [types.importDefaultSpecifier(specifier.local)],\n                        types.stringLiteral(libraryDirectory?\n                            `${libraryName}/${libraryDirectory}/${specifier.imported.name}`\n                            :`${libraryName}/${specifier.imported.name}`)\n                    ); */\n          })\n          path.replaceWithMultiple(newImportDeclarations)\n        }\n      },\n    },\n  }\n}\nmodule.exports = babelPluginImport\n')),(0,r.kt)("h2",{id:"7-\u53c2\u8003"},"7. \u53c2\u8003"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md#asts"},"Babel \u63d2\u4ef6\u624b\u518c")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/babel/babel/tree/master/packages/babel-types"},"babel-types")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://astexplorer.net/"},"\u4e0d\u540c\u7684 parser \u89e3\u6790 js \u4ee3\u7801\u540e\u5f97\u5230\u7684 AST")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://resources.jointjs.com/demos/javascript-ast"},"\u5728\u7ebf\u53ef\u89c6\u5316\u7684\u770b\u5230 AST")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://zhuanlan.zhihu.com/p/28143410"},"babel \u4ece\u5165\u95e8\u5230\u5165\u95e8\u7684\u77e5\u8bc6\u5f52\u7eb3")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://octman.com/blog/2016-08-27-babel-notes/"},"Babel \u5185\u90e8\u539f\u7406\u5206\u6790")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/chikara-chan/babel-plugin-react-scope-binding"},"babel-plugin-react-scope-binding")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/babel-plugin-transform-runtime"},"transform-runtime")," Babel \u9ed8\u8ba4\u53ea\u8f6c\u6362\u65b0\u7684 JavaScript \u8bed\u6cd5\uff0c\u800c\u4e0d\u8f6c\u6362\u65b0\u7684 API\u3002\u4f8b\u5982\uff0cIterator\u3001Generator\u3001Set\u3001Maps\u3001Proxy\u3001Reflect\u3001Symbol\u3001Promise \u7b49\u5168\u5c40\u5bf9\u8c61\uff0c\u4ee5\u53ca\u4e00\u4e9b\u5b9a\u4e49\u5728\u5168\u5c40\u5bf9\u8c61\u4e0a\u7684\u65b9\u6cd5\uff08\u6bd4\u5982 Object.assign\uff09\u90fd\u4e0d\u4f1a\u8f6c\u8bd1,\u542f\u7528\u63d2\u4ef6 ",(0,r.kt)("inlineCode",{parentName:"li"},"babel-plugin-transform-runtime")," \u540e\uff0cBabel \u5c31\u4f1a\u4f7f\u7528 babel-runtime \u4e0b\u7684\u5de5\u5177\u51fd\u6570"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/babel/babylon/blob/master/ast/spec.md"},"ast-spec")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/README.md"},"babel-handbook"))))}c.isMDXComponent=!0}}]);